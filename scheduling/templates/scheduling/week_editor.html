{% extends "scheduling/base.html" %}
{% load schedule_extras %}
{% block title %}Week - Staff Schedule{% endblock %}

{% block content %}
<div class="rounded-xl shadow overflow-hidden" style="{% if theme.header_bg_type == 'gradient' %}background-image: linear-gradient(90deg, {{ theme.header_bg_color1 }}, {{ theme.header_bg_color2 }});{% else %}background-color: {{ theme.header_bg_color1 }};{% endif %}color: {{ theme.header_text_color }};">
    <div class="p-4">
        <div class="flex items-center justify-between gap-3 flex-wrap">
            <div class="flex items-center gap-2 flex-wrap">
                <a href="/schedule/week/{{ prev_week }}/" class="rounded-lg border border-white/30 bg-white/10 px-3 py-2 text-sm">‚Üê Prev</a>
                <a href="/schedule/week/{{ next_week }}/" class="rounded-lg border border-white/30 bg-white/10 px-3 py-2 text-sm">Next ‚Üí</a>
                <div class="ml-1">
                    <div class="text-sm opacity-90">Week</div>
                    <div class="text-lg font-semibold">{{ schedule.week_start|date:"d M Y" }} - {{ schedule.week_end|date:"d M Y" }}</div>
                </div>
            </div>

            <div class="flex items-center gap-2 flex-wrap">
                <a href="/schedule/week/{{ week_start }}/pdf/?style=1" class="rounded-lg bg-white text-gray-900 px-3 py-2 text-sm font-semibold">PDF A</a>
                <a href="/schedule/week/{{ week_start }}/pdf/?style=2" class="rounded-lg border border-white/30 bg-white/10 px-3 py-2 text-sm">PDF B</a>
                <div class="hidden sm:block w-px bg-white/30 mx-1"></div>
                <a href="/schedule/week/{{ week_start }}/png/?dpi=450&style=1" class="rounded-lg border border-white/30 bg-white/10 px-3 py-2 text-sm">Image 450dpi</a>
                <a href="/schedule/week/{{ week_start }}/png/?dpi=600&style=1" class="rounded-lg border border-white/30 bg-white/10 px-3 py-2 text-sm">Image 600dpi</a>
            </div>
        </div>

        <div class="mt-3 text-sm opacity-90">
            Configure in <a href="/schedule/theme/" class="underline font-medium">Theme</a> and per-slot colors in <a href="/schedule/slots/" class="underline font-medium">Slots</a>.
        </div>
    </div>
</div>

<meta name="csrf-token" content="{{ csrf_token }}">

<div id="toast" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 bg-black text-white text-sm px-4 py-2 rounded-full shadow"></div>

{{ staff_map|json_script:"staffNameMapJson" }}

<div class="bg-white rounded-xl shadow p-3 mb-3">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
            <div class="font-semibold text-sm">Staff (drag into cells)</div>
            <div class="text-xs text-gray-500">Rule: a staff can only be assigned once per day. Off Day & PH/AL are exclusive.</div>
        </div>
        <div class="text-xs text-gray-500">
            Tip: Tap a staff, then tap a cell (fallback if drag is hard on mobile).
        </div>
    </div>

    <div id="staffRoster" class="mt-3 flex flex-wrap gap-2">
        {% for s in staff %}
            <div class="roster-chip select-none cursor-grab active:cursor-grabbing px-3 py-2 rounded-full border bg-gray-50 text-base font-semibold flex items-center gap-2"
                 data-staff-id="{{ s.id }}">
                <span>{{ s.name }}</span>
            </div>
        {% empty %}
            <div class="text-sm text-gray-500">Add staff first.</div>
        {% endfor %}
    </div>
</div>

<div class="bg-white rounded-xl shadow overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-[980px] w-full border-collapse">
            <thead>
                <tr>
                    <th class="sticky left-0 z-10 border border-black px-3 py-3 text-base font-bold whitespace-nowrap"
                        style="background-color: {{ theme.table_header_bg }}; color: {{ theme.table_header_text }};">
                        Shift
                    </th>
                    {% for h in day_headers %}
                        <th class="border border-black px-3 py-3 text-base font-bold"
                            style="background-color: {{ theme.table_header_bg }}; color: {{ theme.table_header_text }};">
                            <div class="leading-tight">{{ h.label }}</div>
                            <div class="text-sm opacity-80 font-semibold">{{ h.date_str }}</div>
                        </th>
                    {% endfor %}
                </tr>
            </thead>

            <tbody>
                {% for slot in slots %}
                    <tr>
                        <td class="sticky left-0 z-10 border border-black px-3 py-3 text-base font-bold whitespace-nowrap"
                            style="{{ slot|style_bg }}">
                            {{ slot.label }}
                        </td>

                        {% for h in day_headers %}
                            {% with cell=schedule.cells|get_dict:slot.key %}
                                {% with day=cell|get_dict:h.key %}
                                    {% with assigned=day|get_list:"staff" %}
                                        {% with blocked=day|get_bool:"blocked" %}
                                            <td class="border border-black px-3 py-3 align-top" data-slot="{{ slot.key }}" data-day="{{ h.key }}" data-blocked="{% if slot.allow_block and blocked %}1{% else %}0{% endif %}">
                                                {% if slot.allow_block and blocked %}
                                                    <div class="w-full h-full rounded" style="background: {{ theme.blocked_bg }}; opacity: 0.65; min-height: 72px;"></div>
                                                {% else %}
                                                    <div class="cell-dropzone min-h-[72px]">
                                                        {% if slot.key == "pt" %}
                                                            <div class="flex items-center gap-2 mb-2">
                                                                <input class="pt-time-input w-28 rounded border px-2 py-1 text-sm font-semibold"
                                                                       value="{{ day|get_str:'pt_time' }}"
                                                                       placeholder="{{ slot.pt_default_time }}">
                                                                <button type="button" class="pt-block-btn rounded border px-3 py-1 text-sm font-semibold">Block</button>
                                                            </div>
                                                        {% endif %}

                                                        <div class="cell-chips flex flex-wrap gap-2">
                                                            {% for staff_id in assigned %}
                                                                <div class="cell-chip px-3 py-2 rounded-full border bg-white text-base font-semibold flex items-center gap-2"
                                                                     data-staff-id="{{ staff_id }}">
                                                                    <span>{{ staff_map|get_item:staff_id }}</span>
                                                                    <button type="button" class="chip-remove text-sm text-gray-500 hover:text-black" title="Remove">‚úï</button>
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </td>
                                        {% endwith %}
                                    {% endwith %}
                                {% endwith %}
                            {% endwith %}
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="border-t p-3 sm:p-4">
        <form method="post" class="space-y-2">
            {% csrf_token %}
            <input type="hidden" name="save_notes" value="1">
            <label class="text-sm font-semibold">Notes</label>
            <textarea name="notes" rows="3" class="w-full rounded-lg border px-3 py-2 text-sm" placeholder="Optional notes...">{{ schedule.notes }}</textarea>
            <button class="rounded-lg bg-black text-white px-4 py-2 text-sm">Save notes</button>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script>
(function () {
    const weekStart = "{{ week_start }}";
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const staffNameMap = JSON.parse(document.getElementById('staffNameMapJson').textContent || "{}");

    const DEBUG = (new URLSearchParams(location.search).get('debug') === '1') || (localStorage.getItem('sched_debug') === '1');

    function toast(msg) {
        const el = document.getElementById('toast');
        el.textContent = msg;
        el.classList.remove('hidden');
        clearTimeout(window.__toastTimer);
        window.__toastTimer = setTimeout(() => el.classList.add('hidden'), 1400);
    }

    function _eventTargetEl(t) {
        if (!t) return null;
        if (t.nodeType === 3) return t.parentElement; // Text node -> parent element (mobile Safari can do this)
        return t;
    }

    function _closest(t, selector) {
        const el = _eventTargetEl(t);
        if (!el) return null;
        if (typeof el.closest !== 'function') return null;
        return el.closest(selector);
    }

    function _createMobileConsole() {
        if (!DEBUG) return null;

        const wrap = document.createElement('div');
        wrap.style.position = 'fixed';
        wrap.style.left = '0';
        wrap.style.right = '0';
        wrap.style.bottom = '0';
        wrap.style.height = '40vh';
        wrap.style.zIndex = '999999';
        wrap.style.background = 'rgba(0,0,0,0.92)';
        wrap.style.color = '#fff';
        wrap.style.fontFamily = 'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
        wrap.style.fontSize = '12px';
        wrap.style.display = 'none';

        const bar = document.createElement('div');
        bar.style.display = 'flex';
        bar.style.alignItems = 'center';
        bar.style.justifyContent = 'space-between';
        bar.style.gap = '8px';
        bar.style.padding = '8px 10px';
        bar.style.borderBottom = '1px solid rgba(255,255,255,0.15)';

        const title = document.createElement('div');
        title.textContent = 'Mobile Console';
        title.style.fontWeight = '700';

        const btns = document.createElement('div');
        btns.style.display = 'flex';
        btns.style.gap = '8px';

        const clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.textContent = 'Clear';
        clearBtn.style.padding = '4px 8px';
        clearBtn.style.border = '1px solid rgba(255,255,255,0.25)';
        clearBtn.style.borderRadius = '8px';
        clearBtn.style.background = 'transparent';
        clearBtn.style.color = '#fff';

        const closeBtn = document.createElement('button');
        closeBtn.type = 'button';
        closeBtn.textContent = 'Close';
        closeBtn.style.padding = '4px 8px';
        closeBtn.style.border = '1px solid rgba(255,255,255,0.25)';
        closeBtn.style.borderRadius = '8px';
        closeBtn.style.background = 'transparent';
        closeBtn.style.color = '#fff';

        btns.appendChild(clearBtn);
        btns.appendChild(closeBtn);

        bar.appendChild(title);
        bar.appendChild(btns);

        const body = document.createElement('div');
        body.style.padding = '8px 10px';
        body.style.overflow = 'auto';
        body.style.height = 'calc(40vh - 44px)';
        body.style.whiteSpace = 'pre-wrap';
        body.style.wordBreak = 'break-word';

        wrap.appendChild(bar);
        wrap.appendChild(body);
        document.body.appendChild(wrap);

        const toggle = document.createElement('button');
        toggle.type = 'button';
        toggle.textContent = 'üêû';
        toggle.title = 'Open mobile console';
        toggle.style.position = 'fixed';
        toggle.style.right = '14px';
        toggle.style.bottom = '14px';
        toggle.style.width = '44px';
        toggle.style.height = '44px';
        toggle.style.borderRadius = '999px';
        toggle.style.background = '#000';
        toggle.style.color = '#fff';
        toggle.style.border = '1px solid rgba(255,255,255,0.25)';
        toggle.style.zIndex = '1000000';
        toggle.style.boxShadow = '0 10px 24px rgba(0,0,0,0.35)';
        document.body.appendChild(toggle);

        function open() { wrap.style.display = 'block'; }
        function close() { wrap.style.display = 'none'; }
        function clear() { body.textContent = ''; }

        toggle.addEventListener('click', () => {
            if (wrap.style.display === 'none') open(); else close();
        });
        closeBtn.addEventListener('click', close);
        clearBtn.addEventListener('click', clear);

        function addLine(level, args) {
            const ts = new Date().toISOString().slice(11, 19);
            const line = `[${ts}] ${level}: ` + args.map((a) => {
                try {
                    if (typeof a === 'string') return a;
                    return JSON.stringify(a);
                } catch (e) {
                    return String(a);
                }
            }).join(' ');
            body.textContent += line + "\n";
            body.scrollTop = body.scrollHeight;
        }

        window.addEventListener('error', (ev) => {
            addLine('ERROR', [ev.message, (ev.filename || ''), (ev.lineno || ''), (ev.colno || '')]);
        });

        window.addEventListener('unhandledrejection', (ev) => {
            addLine('PROMISE', [ev.reason]);
        });

        return {
            log: (...args) => addLine('LOG', args),
            warn: (...args) => addLine('WARN', args),
            error: (...args) => addLine('ERR', args),
        };
    }

    const mconsole = _createMobileConsole();
    function mlog() { if (mconsole) mconsole.log.apply(null, arguments); }
    function mwarn() { if (mconsole) mconsole.warn.apply(null, arguments); }
    function merror() { if (mconsole) mconsole.error.apply(null, arguments); }

    async function postJSON(url, payload) {
        mlog('POST', url, payload);

        let res;
        try {
            res = await fetch(url, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify(payload),
            });
        } catch (e) {
            merror('FETCH_FAIL', e && e.message ? e.message : e);
            throw new Error('Network error');
        }

        const ct = (res.headers.get('content-type') || '').toLowerCase();
        let data = {};
        if (ct.includes('application/json')) {
            data = await res.json().catch(() => ({}));
        } else {
            const txt = await res.text().catch(() => '');
            data = { _raw: txt };
        }

        mlog('RESP', res.status, data);

        if (!res.ok || (data && data.ok === false)) {
            const msg = (data && data.error) ? data.error : `HTTP ${res.status}`;
            throw new Error(msg);
        }

        return data;
    }

    function escapeHtml(s) {
        return String(s)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#039;');
    }

    function getStaffName(id) {
        return staffNameMap[String(id)] || 'Staff';
    }

    function ensureDropzone(td) {
        let dz = td.querySelector('.cell-dropzone');
        if (!dz) {
            td.innerHTML = '<div class="cell-dropzone min-h-[72px]"></div>';
            dz = td.querySelector('.cell-dropzone');
        }

        if (dz && !dz.__sortableAttached) {
            dz.__sortableAttached = true;

            if (!window.Sortable) {
                mwarn('SortableJS not loaded (CSP/CDN?). Drag disabled, tap-to-assign still works.');
                return dz;
            }

            new Sortable(dz, {
                group: { name: 'staff', pull: false, put: true },
                sort: false,
                animation: 150,
                fallbackOnBody: true,
                forceFallback: true,
                filter: '.chip-remove,.pt-time-input,.pt-block-btn',
                preventOnFilter: false,
                onAdd: async function (evt) {
                    const staffId = parseInt(evt.item.getAttribute('data-staff-id'), 10);
                    const slotKey = td.getAttribute('data-slot');
                    const dayKey = td.getAttribute('data-day');

                    evt.item.remove();
                    try {
                        const data = await postJSON(`/schedule/api/week/${weekStart}/cell/update/`, {
                            slot_key: slotKey,
                            day_key: dayKey,
                            action: 'add',
                            staff_id: staffId,
                            pt_time: null,
                        });
                        renderCell(td, data.staff_ids || [], data.pt_time || "", data.blocked || false);
                        toast('Added');
                    } catch (e) {
                        toast(e.message);
                    }
                }
            });
        }
        return dz;
    }

    let selectedStaffId = null;
    document.querySelectorAll('#staffRoster .roster-chip').forEach((chip) => {
        chip.addEventListener('click', () => {
            const sid = parseInt(chip.getAttribute('data-staff-id'), 10);
            selectedStaffId = sid;
            document.querySelectorAll('#staffRoster .roster-chip').forEach((c) => c.classList.remove('ring','ring-black'));
            chip.classList.add('ring','ring-black');
            toast('Selected: ' + getStaffName(sid) + ' ‚Üí tap a cell');
        });
    });

    const staffRoster = document.getElementById('staffRoster');
    if (staffRoster && window.Sortable) {
        new Sortable(staffRoster, {
            group: { name: 'staff', pull: 'clone', put: false },
            sort: false,
            animation: 150,
            fallbackOnBody: true,
            forceFallback: true,
            ghostClass: 'opacity-70',
            filter: '.chip-remove',
            preventOnFilter: false,
        });
    } else if (staffRoster && !window.Sortable) {
        mwarn('SortableJS missing: roster drag disabled.');
    }

    document.querySelectorAll('td[data-slot][data-day]').forEach((td) => {
        const slotKey = td.getAttribute('data-slot');
        const dayKey = td.getAttribute('data-day');

        const isBlocked = td.getAttribute('data-blocked') === '1';
        if (!isBlocked) {
            ensureDropzone(td);
        }

        td.addEventListener('click', async (e) => {
            if (_closest(e.target, '.chip-remove') || _closest(e.target, '.pt-time-input') || _closest(e.target, '.pt-block-btn')) return;

            const nowBlocked = td.getAttribute('data-blocked') === '1';
            if (slotKey === 'pt' && nowBlocked) {
                try {
                    const data = await postJSON(`/schedule/api/week/${weekStart}/cell/block/`, {
                        slot_key: slotKey,
                        day_key: dayKey,
                    });
                    renderCell(td, data.staff_ids || [], data.pt_time || "", data.blocked || false);
                    toast(data.blocked ? 'Blocked' : 'Unblocked');
                } catch (e2) {
                    toast(e2.message);
                }
                return;
            }

            if (!selectedStaffId) return;

            try {
                const data = await postJSON(`/schedule/api/week/${weekStart}/cell/update/`, {
                    slot_key: slotKey,
                    day_key: dayKey,
                    action: 'add',
                    staff_id: selectedStaffId,
                    pt_time: null,
                });
                renderCell(td, data.staff_ids || [], data.pt_time || "", data.blocked || false);
                toast('Added');
            } catch (e2) {
                toast(e2.message);
            }
        });
    });

    function renderCell(td, staffIds, ptTime, blocked) {
        const slotKey = td.getAttribute('data-slot');
        td.setAttribute('data-blocked', blocked ? '1' : '0');

        if (blocked) {
            td.innerHTML = `<div class="w-full h-full rounded" style="background: {{ theme.blocked_bg }}; opacity: 0.65; min-height: 72px;"></div>`;
            return;
        }

        const dropzone = ensureDropzone(td);

        let html = '';
        if (slotKey === 'pt') {
            const safeTime = ptTime ? String(ptTime) : '';
            html += `
                <div class="flex items-center gap-2 mb-2">
                    <input class="pt-time-input w-28 rounded border px-2 py-1 text-sm font-semibold" value="${escapeHtml(safeTime)}" placeholder="7-11">
                    <button type="button" class="pt-block-btn rounded border px-3 py-1 text-sm font-semibold">Block</button>
                </div>
            `;
        }

        html += '<div class="cell-chips flex flex-wrap gap-2">';
        (staffIds || []).forEach((sid) => {
            const name = getStaffName(sid);
            html += `
                <div class="cell-chip px-3 py-2 rounded-full border bg-white text-base font-semibold flex items-center gap-2" data-staff-id="${sid}">
                    <span>${escapeHtml(name)}</span>
                    <button type="button" class="chip-remove text-sm text-gray-500 hover:text-black" title="Remove">‚úï</button>
                </div>
            `;
        });
        html += '</div>';
        dropzone.innerHTML = html;
    }

    let __tapGuard = 0;
    function _guardDoubleTap() {
        const now = Date.now();
        if (now - __tapGuard < 450) return true;
        __tapGuard = now;
        return false;
    }

    async function _handleChipRemove(e) {
        const btn = _closest(e.target, '.chip-remove');
        if (!btn) return;

        if (e.type === 'touchend') {
            e.preventDefault();
            if (_guardDoubleTap()) return;
        }

        const chip = btn.closest('.cell-chip');
        const td = btn.closest('td[data-slot][data-day]');
        if (!chip || !td) return;

        const staffId = parseInt(chip.getAttribute('data-staff-id'), 10);
        const slotKey = td.getAttribute('data-slot');
        const dayKey = td.getAttribute('data-day');

        try {
            const data = await postJSON(`/schedule/api/week/${weekStart}/cell/update/`, {
                slot_key: slotKey,
                day_key: dayKey,
                action: 'remove',
                staff_id: staffId,
                pt_time: null,
            });
            renderCell(td, data.staff_ids || [], data.pt_time || "", data.blocked || false);
            toast('Removed');
        } catch (e2) {
            toast(e2.message);
        }
    }

    document.addEventListener('click', _handleChipRemove);
    document.addEventListener('touchend', _handleChipRemove, { passive: false });

    let ptTimer = null;
    document.addEventListener('input', function (e) {
        const inp = _closest(e.target, '.pt-time-input');
        if (!inp) return;
        const td = inp.closest('td[data-slot][data-day]');
        if (!td) return;

        clearTimeout(ptTimer);
        ptTimer = setTimeout(async () => {
            const slotKey = td.getAttribute('data-slot');
            const dayKey = td.getAttribute('data-day');
            const ptTime = inp.value.trim();

            try {
                await postJSON(`/schedule/api/week/${weekStart}/cell/update/`, {
                    slot_key: slotKey,
                    day_key: dayKey,
                    action: 'set_pt_time',
                    staff_id: null,
                    pt_time: ptTime,
                });
                toast('Saved');
            } catch (e2) {
                toast(e2.message);
            }
        }, 450);
    });

    async function _handlePtBlock(e) {
        const btn = _closest(e.target, '.pt-block-btn');
        if (!btn) return;

        if (e.type === 'touchend') {
            e.preventDefault();
            if (_guardDoubleTap()) return;
        }

        const td = btn.closest('td[data-slot][data-day]');
        if (!td) return;

        const slotKey = td.getAttribute('data-slot');
        const dayKey = td.getAttribute('data-day');

        try {
            const data = await postJSON(`/schedule/api/week/${weekStart}/cell/block/`, {
                slot_key: slotKey,
                day_key: dayKey,
            });
            renderCell(td, data.staff_ids || [], data.pt_time || "", data.blocked || false);
            toast(data.blocked ? 'Blocked' : 'Unblocked');
        } catch (e2) {
            toast(e2.message);
        }
    }

    document.addEventListener('click', _handlePtBlock);
    document.addEventListener('touchend', _handlePtBlock, { passive: false });

    if (DEBUG) {
        mlog('DEBUG enabled');
        mlog('UserAgent:', navigator.userAgent);
        mlog('Sortable present:', !!window.Sortable);
    }
})();
</script>

{% endblock %}
